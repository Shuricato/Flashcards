<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SD.CPP Web UI</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { margin-bottom: 20px; color: #fff; }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            overflow-x: auto;
            flex-wrap: nowrap;
        }
        .tab {
            padding: 12px 24px;
            background: #1a1a1a;
            border: none;
            color: #aaa;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .tab.active {
            background: #2a2a2a;
            color: #fff;
            border-bottom: 2px solid #4a9eff;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .section {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            margin-bottom: 15px;
        }
        .section-header h3 {
            color: #4a9eff;
            font-size: 16px;
        }
        .collapse-icon {
            transition: transform 0.2s;
            color: #666;
        }
        .section.collapsed .collapse-icon { transform: rotate(-90deg); }
        .section.collapsed .section-body { display: none; }
        
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 13px;
        }
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px;
            background: #0a0a0a;
            border: 1px solid #333;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 14px;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        input[type="range"] {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            outline: none;
        }
        .range-value {
            display: inline-block;
            min-width: 50px;
            text-align: right;
            color: #4a9eff;
            font-weight: 600;
        }
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .slider-container input[type="range"] { flex: 1; }
        
        button {
            padding: 12px 24px;
            background: #4a9eff;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }
        button:hover { background: #3a8eef; }
        button:disabled {
            background: #333;
            cursor: not-allowed;
        }
        .btn-danger {
            background: #ff4a4a;
        }
        .btn-danger:hover { background: #ef3a3a; }
        .btn-secondary {
            background: #333;
        }
        .btn-secondary:hover { background: #444; }
        
        .lora-item {
            background: #0a0a0a;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .lora-item select { flex: 1; }
        .lora-item input[type="number"] { width: 80px; }
        .lora-item button { padding: 8px 12px; }
        
        .resolution-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            align-items: end;
        }
        .aspect-preview {
            width: 80px;
            height: 80px;
            border: 2px solid #4a9eff;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .aspect-box {
            background: #4a9eff;
            opacity: 0.3;
        }
        
        .canvas-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
            margin: 20px 0;
        }
        canvas {
            border: 2px solid #333;
            border-radius: 8px;
            max-width: 100%;
            cursor: crosshair;
            touch-action: none;
        }
        .canvas-tools {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        .gallery-item {
            background: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .gallery-item:hover { transform: scale(1.02); }
        .gallery-item img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            display: block;
        }
        .gallery-info {
            padding: 10px;
            font-size: 12px;
            color: #aaa;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            padding: 20px;
            overflow: auto;
        }
        .modal.active { display: flex; }
        .modal-content {
            margin: auto;
            max-width: 1200px;
            width: 100%;
        }
        .modal-image {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .modal-metadata {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
        }
        .modal-close {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 32px;
            color: #fff;
            cursor: pointer;
        }
        
        .status {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #4a9eff;
        }
        .status.error { border-left-color: #ff4a4a; }
        .status.success { border-left-color: #4aff4a; }
        
        .console {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 15px;
            white-space: pre-wrap;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a9eff, #3a8eef);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SD.CPP Web UI</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('txt2img')">Text to Image</button>
            <button class="tab" onclick="switchTab('img2img')">Image to Image</button>
            <button class="tab" onclick="switchTab('lora-browser')">LoRA Browser</button>
            <button class="tab" onclick="switchTab('gallery')">Gallery</button>
        </div>
        
        <!-- Text to Image -->
        <div id="txt2img" class="tab-content active">
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>Prompt</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <label>Positive Prompt</label>
                        <textarea id="prompt" placeholder="A beautiful landscape..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Negative Prompt</label>
                        <textarea id="negative_prompt" placeholder="blurry, low quality..."></textarea>
                    </div>
                </div>
            </div>     
            <div id="progress-txt2img" style="display: none;">
                <div class="progress-bar"><div class="progress-fill"></div></div>
                <div class="console" id="console-txt2img"></div>
            </div>
            
            <div id="status-txt2img"></div>
        </div>
        
        <!-- Image to Image -->
        <div id="img2img" class="tab-content">
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>Input Image</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-body">
                    <input type="file" id="img2img-input" accept="image/*" onchange="loadImage('img2img')">
                    <div class="canvas-container">
                        <canvas id="img2img-canvas"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>Image-to-Image Settings</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <label>Positive Prompt</label>
                        <textarea id="prompt-img2img"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Negative Prompt</label>
                        <textarea id="negative_prompt-img2img"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Denoising Strength</label>
                        <div class="slider-container">
                            <input type="range" id="strength" min="0" max="1" step="0.05" value="0.75" oninput="updateSlider(this)">
                            <span class="range-value">0.75</span>
                        </div>
                        <small style="color: #666;">Higher = more changes from original. 0.5-0.7 for variations, 0.75-0.9 for major changes</small>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="generate('img2img')" style="flex: 1;">Generate</button>
                <button class="btn-danger" onclick="interrupt()">Interrupt</button>
            </div>
            
            <div id="progress-img2img" style="display: none;">
                <div class="progress-bar"><div class="progress-fill"></div></div>
                <div class="console" id="console-img2img"></div>
            </div>
            
            <div id="status-img2img"></div>
        </div>
        
        <!-- LoRA Browser -->
        <div id="lora-browser" class="tab-content">
            <div style="margin-bottom: 20px;">
                <button onclick="refreshLoraBrowser()">Refresh LoRA List</button>
                <input type="text" id="lora-search" placeholder="Search LoRAs..." style="margin-left: 10px; width: 300px;" oninput="filterLoras()">
            </div>
            
            <div class="gallery" id="lora-browser-grid"></div>
        </div>
        
        <!-- Shared Settings (visible on all tabs except gallery and lora browser) -->
        <div id="shared-settings">            
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>Model & Resources</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <label>Checkpoint</label>
                        <select id="model"></select>
                    </div>
                    <div class="form-group">
                        <label>VAE (Optional)</label>
                        <select id="vae">
                            <option value="">None</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantization</label>
                        <select id="quantization">
                            <option value="q8_0">Q8_0</option>
                            <option value="q4_0">Q4_0</option>
                            <option value="q4_1">Q4_1</option>
                            <option value="q5_0">Q5_0</option>
                            <option value="q5_1">Q5_1</option>
                            <option value="f16">F16</option>
                            <option value="f32">F32</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>LoRAs</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-body">
                    <div id="lora-list"></div>
                    <button onclick="addLora()">Add LoRA</button>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>Generation Parameters</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <label>Sampler</label>
                        <select id="sampler">
                            <option value="euler_a">Euler A</option>
                            <option value="euler">Euler</option>
                            <option value="heun">Heun</option>
                            <option value="dpm2">DPM2</option>
                            <option value="dpm++2s_a">DPM++ 2S A</option>
                            <option value="dpm++2m">DPM++ 2M</option>
                            <option value="dpm++2mv2">DPM++ 2M V2</option>
                            <option value="lcm">LCM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Steps</label>
                        <div class="slider-container">
                            <input type="range" id="steps" min="1" max="60" value="20" oninput="updateSlider(this)">
                            <span class="range-value">20</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>CFG Scale</label>
                        <div class="slider-container">
                            <input type="range" id="cfg_scale" min="1" max="15" step="0.5" value="7" oninput="updateSlider(this)">
                            <span class="range-value">7.0</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Clip Skip</label>
                        <div class="slider-container">
                            <input type="range" id="clip_skip" min="0" max="2" value="0" oninput="updateSlider(this)">
                            <span class="range-value">0</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Seed (-1 for random)</label>
                        <input type="number" id="seed" value="-1">
                    </div>
                    <div class="form-group">
                        <label>Batch Size</label>
                        <div class="slider-container">
                            <input type="range" id="batch_size" min="1" max="6" value="1" oninput="updateSlider(this)">
                            <span class="range-value">1</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>Resolution</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-body">
                    <div class="resolution-grid">
                        <div class="form-group">
                            <label>Width</label>
                            <input type="number" id="width" value="512" step="64" min="64" max="2048" oninput="updateAspectPreview()">
                        </div>
                        <div class="form-group">
                            <label>Height</label>
                            <input type="number" id="height" value="512" step="64" min="64" max="2048" oninput="updateAspectPreview()">
                        </div>
                        <div class="aspect-preview" id="aspect-preview">
                            <div class="aspect-box"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>Upscaling</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <label>Upscaler Model</label>
                        <select id="upscaler">
                            <option value="">None</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Upscale Factor</label>
                        <div class="slider-container">
                            <input type="range" id="upscale_factor" min="0" max="1" value="1" oninput="updateSlider(this)">
                            <span class="range-value">2</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="generate('txt2img')" style="flex: 1;">Generate</button>
                <button class="btn-danger" onclick="interrupt()">Interrupt</button>
            </div>
            
            <div id="progress-txt2img" style="display: none;">
                <div class="progress-bar"><div class="progress-fill"></div></div>
                <div class="console" id="console-txt2img"></div>
            </div>
            
            <div id="status-txt2img"></div>
        </div>
        
        <!-- Image to Image -->
        <div id="img2img" class="tab-content">
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>Input Image</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-body">
                    <input type="file" id="img2img-input" accept="image/*" onchange="loadImage('img2img')">
                    <div class="canvas-container">
                        <canvas id="img2img-canvas"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>Prompt</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <label>Positive Prompt</label>
                        <textarea id="prompt-img2img"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Negative Prompt</label>
                        <textarea id="negative_prompt-img2img"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Denoising Strength</label>
                        <div class="slider-container">
                            <input type="range" id="strength" min="0" max="1" step="0.05" value="0.75" oninput="updateSlider(this)">
                            <span class="range-value">0.75</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="generate('img2img')" style="flex: 1;">Generate</button>
                <button class="btn-danger" onclick="interrupt()">Interrupt</button>
            </div>
            
            <div id="progress-img2img" style="display: none;">
                <div class="progress-bar"><div class="progress-fill"></div></div>
                <div class="console" id="console-img2img"></div>
            </div>
            
            <div id="status-img2img"></div>
        </div>
        
        <!-- Inpainting -->
        <div id="inpaint" class="tab-content">
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>Input Image & Mask</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-body">
                    <input type="file" id="inpaint-input" accept="image/*" onchange="loadImage('inpaint')">
                    <div class="canvas-tools">
                        <button onclick="setPaintMode('draw')">Draw Mask</button>
                        <button onclick="setPaintMode('erase')">Erase Mask</button>
                        <button onclick="clearMask()">Clear Mask</button>
                        <label>Brush Size: <input type="range" id="brush-size" min="5" max="100" value="30"></label>
                    </div>
                    <div class="canvas-container">
                        <canvas id="inpaint-canvas"></canvas>
                        <canvas id="mask-canvas" style="position: absolute; top: 0; left: 0;"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    <h3>Prompt</h3>
                    <span class="collapse-icon">▼</span>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <label>Positive Prompt</label>
                        <textarea id="prompt-inpaint"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Negative Prompt</label>
                        <textarea id="negative_prompt-inpaint"></textarea>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="generate('inpaint')" style="flex: 1;">Generate</button>
                <button class="btn-danger" onclick="interrupt()">Interrupt</button>
            </div>
            
            <div id="progress-inpaint" style="display: none;">
                <div class="progress-bar"><div class="progress-fill"></div></div>
                <div class="console" id="console-inpaint"></div>
            </div>
            
            <div id="status-inpaint"></div>
        </div>
        
        <!-- Gallery -->
        <div id="gallery" class="tab-content">
            <div style="margin-bottom: 20px;">
                <button onclick="loadGallery()">Refresh Gallery</button>
            </div>
            <div class="gallery" id="gallery-grid"></div>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="modal" class="modal">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img id="modal-image" class="modal-image">
            <div class="modal-metadata" id="modal-metadata"></div>
        </div>
    </div>
    
    <script>
        // State
        let state = {
            models: [],
            loras: [],
            vaes: [],
            upscalers: [],
            loraItems: [],
            paintMode: 'draw',
            painting: false,
            currentImage: null,
            pollInterval: null,
            currentMode: null
        };
        
        // Load resources
        async function loadResources() {
            try {
                const [models, loras, vaes, upscalers] = await Promise.all([
                    fetch('/api/list/models').then(r => r.json()),
                    fetch('/api/list/loras').then(r => r.json()),
                    fetch('/api/list/vaes').then(r => r.json()),
                    fetch('/api/list/upscalers').then(r => r.json())
                ]);
                
                state.models = models.models || [];
                state.loras = loras.loras || [];
                state.vaes = vaes.vaes || [];
                state.upscalers = upscalers.upscalers || [];
                
                updateSelects();
                return Promise.resolve();
            } catch (e) {
                console.error('Failed to load resources:', e);
                return Promise.reject(e);
            }
        }
        
        function updateSelects() {
            // Load saved settings first
            const saved = localStorage.getItem('sdcpp_settings');
            let savedSettings = {};
            if (saved) {
                try {
                    savedSettings = JSON.parse(saved);
                } catch (e) {}
            }
            
            const modelSelect = document.getElementById('model');
            modelSelect.innerHTML = state.models.map(m => `<option value="${m}">${m}</option>`).join('');
            if (savedSettings.model && state.models.includes(savedSettings.model)) {
                modelSelect.value = savedSettings.model;
            }
            
            const vaeSelect = document.getElementById('vae');
            vaeSelect.innerHTML = '<option value="">None</option>' + 
                state.vaes.map(v => `<option value="${v}">${v}</option>`).join('');
            if (savedSettings.vae !== undefined && (savedSettings.vae === '' || state.vaes.includes(savedSettings.vae))) {
                vaeSelect.value = savedSettings.vae;
            }
            
            const upscalerSelect = document.getElementById('upscaler');
            upscalerSelect.innerHTML = '<option value="">None</option>' + 
                state.upscalers.map(u => `<option value="${u}">${u}</option>`).join('');
            if (savedSettings.upscaler !== undefined && (savedSettings.upscaler === '' || state.upscalers.includes(savedSettings.upscaler))) {
                upscalerSelect.value = savedSettings.upscaler;
            }
            
            renderLoras();
        }
        
        // LoRA management
        function addLora() {
            const id = Date.now();
            state.loraItems.push({ id, name: '', weight: 1.0 });
            renderLoras();
        }
        
        function removeLora(id) {
            state.loraItems = state.loraItems.filter(l => l.id !== id);
            renderLoras();
        }
        
        function renderLoras() {
            const container = document.getElementById('lora-list');
            container.innerHTML = state.loraItems.map(lora => {
                const loraData = state.loras.find(l => l.name === lora.name);
                const triggers = loraData && loraData.triggers && loraData.triggers.length > 0 
                    ? `<div style="color: #4a9eff; font-size: 11px; margin-top: 5px;">Triggers: ${loraData.triggers.join(', ')}</div>`
                    : '';
                
                return `
                    <div class="lora-item" style="flex-wrap: wrap;">
                        <select style="flex: 1; min-width: 200px;" onchange="updateLora(${lora.id}, 'name', this.value)">
                            <option value="">Select LoRA...</option>
                            ${state.loras.map(l => `<option value="${l.name}" ${l.name === lora.name ? 'selected' : ''}>${l.name}</option>`).join('')}
                        </select>
                        <input type="number" min="0" max="2" step="0.1" value="${lora.weight}" 
                               onchange="updateLora(${lora.id}, 'weight', this.value)" placeholder="Weight" style="width: 80px;">
                        <button class="btn-danger" onclick="removeLora(${lora.id})">Remove</button>
                        ${triggers}
                    </div>
                `;
            }).join('');
        }
        
        function updateLora(id, field, value) {
            const lora = state.loraItems.find(l => l.id === id);
            if (lora) {
                lora[field] = field === 'weight' ? parseFloat(value) : value;
            }
        }
        
        // UI helpers
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
            
            // Show/hide shared settings based on tab
            const sharedSettings = document.getElementById('shared-settings');
            if (tab === 'gallery' || tab === 'lora-browser') {
                sharedSettings.style.display = 'none';
            } else {
                sharedSettings.style.display = 'block';
            }
            
            if (tab === 'gallery') loadGallery();
            if (tab === 'lora-browser') refreshLoraBrowser();
        }
        
        function toggleSection(header) {
            header.parentElement.classList.toggle('collapsed');
        }
        
        function updateSlider(slider) {
            slider.nextElementSibling.textContent = slider.value;
            saveSettings();
        }
        
        function updateAspectPreview() {
            const w = parseInt(document.getElementById('width').value);
            const h = parseInt(document.getElementById('height').value);
            const preview = document.getElementById('aspect-preview');
            const box = preview.querySelector('.aspect-box');
            
            const maxDim = 70;
            const scale = Math.min(maxDim / w, maxDim / h);
            box.style.width = (w * scale) + 'px';
            box.style.height = (h * scale) + 'px';
            
            saveSettings();
        }
        
        // Canvas for img2img and inpainting
        function loadImage(mode) {
            const input = document.getElementById(`${mode}-input`);
            const canvas = document.getElementById(`${mode}-canvas`);
            const ctx = canvas.getContext('2d');
            
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    if (mode === 'inpaint') {
                        const maskCanvas = document.getElementById('mask-canvas');
                        maskCanvas.width = img.width;
                        maskCanvas.height = img.height;
                        maskCanvas.style.width = canvas.style.width;
                        maskCanvas.style.height = canvas.style.height;
                    }
                    
                    state.currentImage = e.target.result;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // Inpainting tools
        function setPaintMode(mode) {
            state.paintMode = mode;
        }
        
        function clearMask() {
            const maskCanvas = document.getElementById('mask-canvas');
            if (maskCanvas) {
                const ctx = maskCanvas.getContext('2d');
                ctx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
            }
        }
        
        // Setup mask painting (not used but keeping for compatibility)
        function setupMaskPainting() {
            // Removed since inpainting tab is replaced
        }
        
        // Generation
        async function generate(mode) {
            const params = {
                mode,
                prompt: document.getElementById('prompt').value,
                negative_prompt: document.getElementById('negative_prompt').value,
                model: document.getElementById('model').value,
                vae: document.getElementById('vae').value,
                quantization: document.getElementById('quantization').value,
                sampler: document.getElementById('sampler').value,
                steps: parseInt(document.getElementById('steps').value),
                cfg_scale: parseFloat(document.getElementById('cfg_scale').value),
                clip_skip: parseInt(document.getElementById('clip_skip').value),
                seed: parseInt(document.getElementById('seed').value),
                batch_size: parseInt(document.getElementById('batch_size').value),
                width: parseInt(document.getElementById('width').value),
                height: parseInt(document.getElementById('height').value),
                upscaler: document.getElementById('upscaler').value,
                upscale_factor: parseInt(document.getElementById('upscale_factor').value),
                loras: state.loraItems.filter(l => l.name)
            };
            
            if (mode === 'img2img') {
                params.input_image = state.currentImage;
                params.strength = parseFloat(document.getElementById('strength').value);
            }
            
            showProgress(mode, true);
            logConsole(mode, 'Starting generation...');
            
            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    logConsole(mode, 'Generation started!');
                    state.currentMode = mode;
                    startProgressPoll(mode);
                } else {
                    showProgress(mode, false);
                    logConsole(mode, 'Error: ' + data.error);
                }
            } catch (e) {
                showProgress(mode, false);
                logConsole(mode, 'Network error: ' + e.message);
            }
        }
        
        async function interrupt() {
            try {
                const res = await fetch('/api/interrupt', { method: 'POST' });
                const data = await res.json();
                if (state.pollInterval) {
                    clearInterval(state.pollInterval);
                    state.pollInterval = null;
                }
                ['txt2img', 'img2img'].forEach(mode => {
                    showProgress(mode, false);
                    logConsole(mode, 'Generation interrupted.');
                });
            } catch (e) {
                console.error('Interrupt failed:', e);
            }
        }
        
        function showProgress(mode, visible) {
            const progress = document.getElementById(`progress-${mode}`);
            if (progress) {
                progress.style.display = visible ? 'block' : 'none';
                if (!visible) {
                    const fill = progress.querySelector('.progress-fill');
                    if (fill) fill.style.width = '0%';
                }
            }
        }
        
        function logConsole(mode, message) {
            const console = document.getElementById(`console-${mode}`);
            if (console) {
                const time = new Date().toLocaleTimeString();
                console.textContent += `[${time}] ${message}\n`;
                console.scrollTop = console.scrollHeight;
            }
        }
        
        function startProgressPoll(mode) {
            if (state.pollInterval) clearInterval(state.pollInterval);
            
            state.pollInterval = setInterval(async () => {
                try {
                    const res = await fetch('/api/status');
                    const data = await res.json();
                    
                    if (data.status && data.status.active) {
                        const percent = data.status.progress || 0;
                        const progress = document.getElementById(`progress-${mode}`);
                        if (progress) {
                            const fill = progress.querySelector('.progress-fill');
                            if (fill) fill.style.width = percent + '%';
                        }
                        
                        // Update console with new log lines
                        if (data.log && data.log.length > 0) {
                            const consoleEl = document.getElementById(`console-${mode}`);
                            if (consoleEl) {
                                consoleEl.textContent = data.log.join('\n') + '\n';
                                consoleEl.scrollTop = consoleEl.scrollHeight;
                            }
                        }
                    } else {
                        // Generation complete
                        clearInterval(state.pollInterval);
                        state.pollInterval = null;
                        
                        const progress = document.getElementById(`progress-${mode}`);
                        if (progress) {
                            const fill = progress.querySelector('.progress-fill');
                            if (fill) fill.style.width = '100%';
                        }
                        
                        logConsole(mode, 'Complete! Loading gallery...');
                        setTimeout(() => {
                            loadGallery();
                            showProgress(mode, false);
                        }, 1000);
                    }
                } catch (e) {
                    console.error('Status poll failed:', e);
                }
            }, 500);
        }
        
        function showStatus(mode, message, type) {
            const statusId = `status-${mode}`;
            let status = document.getElementById(statusId);
            if (!status) {
                status = document.createElement('div');
                status.id = statusId;
                document.getElementById(mode).appendChild(status);
            }
            status.className = `status ${type}`;
            status.textContent = message;
        }
        
        // Gallery
        async function loadGallery() {
            try {
                const res = await fetch('/api/gallery');
                const data = await res.json();
                
                const grid = document.getElementById('gallery-grid');
                grid.innerHTML = data.images.map(img => `
                    <div class="gallery-item" onclick="showImage('${img.filename}')">
                        <img src="/api/image/${img.filename}" alt="${img.filename}">
                        <div class="gallery-info">
                            ${new Date(img.timestamp * 1000).toLocaleString()}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load gallery:', e);
            }
        }
        
        async function showImage(filename) {
            try {
                const res = await fetch(`/api/metadata/${filename}`);
                const metadata = await res.json();
                
                document.getElementById('modal-image').src = `/api/image/${filename}`;
                
                const metaDiv = document.getElementById('modal-metadata');
                metaDiv.innerHTML = `
                    <h3>${filename}</h3>
                    ${Object.entries(metadata).map(([key, value]) => {
                        if (key === 'loras' && Array.isArray(value)) {
                            return `<p><strong>${key}:</strong> ${value.map(l => `${l.name} (${l.weight})`).join(', ')}</p>`;
                        }
                        return `<p><strong>${key}:</strong> ${typeof value === 'object' ? JSON.stringify(value) : value}</p>`;
                    }).join('')}
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="loadToGenerate(${JSON.stringify(metadata).replace(/"/g, '&quot;')}, 'txt2img')">Load to Text-to-Image</button>
                        <button onclick="loadToGenerate(${JSON.stringify(metadata).replace(/"/g, '&quot;')}, 'img2img')">Load to Img2Img</button>
                    </div>
                `;
                
                document.getElementById('modal').classList.add('active');
            } catch (e) {
                console.error('Failed to load image metadata:', e);
            }
        }
        
        function loadToGenerate(metadata, targetTab) {
            // Load all shared settings
            if (metadata.prompt) document.getElementById('prompt').value = metadata.prompt;
            if (metadata.negative_prompt) document.getElementById('negative_prompt').value = metadata.negative_prompt;
            if (metadata.steps) document.getElementById('steps').value = metadata.steps;
            if (metadata.cfg_scale) document.getElementById('cfg_scale').value = metadata.cfg_scale;
            if (metadata.seed) document.getElementById('seed').value = metadata.seed;
            if (metadata.width) document.getElementById('width').value = metadata.width;
            if (metadata.height) document.getElementById('height').value = metadata.height;
            if (metadata.sampler) document.getElementById('sampler').value = metadata.sampler;
            if (metadata.clip_skip) document.getElementById('clip_skip').value = metadata.clip_skip;
            if (metadata.quantization) document.getElementById('quantization').value = metadata.quantization;
            if (metadata.model) document.getElementById('model').value = metadata.model;
            if (metadata.vae) document.getElementById('vae').value = metadata.vae;
            if (metadata.upscaler) document.getElementById('upscaler').value = metadata.upscaler;
            
            if (metadata.loras) {
                state.loraItems = metadata.loras.map((l, i) => ({
                    id: Date.now() + i,
                    name: l.name,
                    weight: l.weight
                }));
                renderLoras();
            }
            
            // Update all range sliders
            document.querySelectorAll('input[type="range"]').forEach(updateSlider);
            updateAspectPreview();
            
            // Close modal and switch to target tab
            closeModal();
            
            // Switch to the target tab
            const tabs = document.querySelectorAll('.tab');
            const tabMap = { 'txt2img': 0, 'img2img': 1, 'lora-browser': 2, 'gallery': 3 };
            const targetIndex = tabMap[targetTab];
            if (targetIndex !== undefined && tabs[targetIndex]) {
                tabs.forEach(t => t.classList.remove('active'));
                tabs[targetIndex].classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(targetTab).classList.add('active');
                
                const sharedSettings = document.getElementById('shared-settings');
                sharedSettings.style.display = (targetTab === 'gallery' || targetTab === 'lora-browser') ? 'none' : 'block';
            }
        }
        
        function loadToPrompt(metadata) {
            loadToGenerate(metadata, 'txt2img');
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }
        
        // LoRA Browser
        let allLoras = [];
        
        async function refreshLoraBrowser() {
            try {
                const res = await fetch('/api/list/loras');
                const data = await res.json();
                allLoras = data.loras || [];
                renderLoraBrowser();
            } catch (e) {
                console.error('Failed to load LoRAs:', e);
            }
        }
        
        function renderLoraBrowser() {
            const container = document.getElementById('lora-browser-grid');
            const searchTerm = document.getElementById('lora-search').value.toLowerCase();
            
            const filtered = allLoras.filter(lora => 
                lora.name.toLowerCase().includes(searchTerm) ||
                (lora.modelName && lora.modelName.toLowerCase().includes(searchTerm)) ||
                (lora.triggers && lora.triggers.some(t => t.toLowerCase().includes(searchTerm)))
            );
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 40px; grid-column: 1/-1;">No LoRAs found</p>';
                return;
            }
            
            container.innerHTML = filtered.map(lora => `
                <div class="gallery-item" onclick="showLoraDetails(${JSON.stringify(lora).replace(/"/g, '&quot;')})">
                    ${lora.thumbnail ? 
                        `<img src="${lora.thumbnail}" alt="${lora.modelName || lora.name}" class="lora-thumbnail" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                         <div class="lora-no-thumb" style="display:none;">No Preview</div>` :
                        `<div class="lora-no-thumb">No Preview</div>`
                    }
                    <div class="gallery-info">
                        <strong>${lora.modelName || lora.name}</strong><br>
                        ${lora.versionName ? `<small>${lora.versionName}</small><br>` : ''}
                        <small style="color: #666;">${lora.name}</small>
                    </div>
                </div>
            `).join('');
        }
        
        function showLoraDetails(lora) {
            const modal = document.getElementById('modal');
            const modalImage = document.getElementById('modal-image');
            const modalMetadata = document.getElementById('modal-metadata');
            
            // Show thumbnail or placeholder
            if (lora.thumbnail) {
                modalImage.src = lora.thumbnail;
                modalImage.style.display = 'block';
            } else {
                modalImage.style.display = 'none';
            }
            
            // Build metadata display
            modalMetadata.innerHTML = `
                <h3>${lora.modelName || lora.name}</h3>
                ${lora.versionName ? `<p><strong>Version:</strong> ${lora.versionName}</p>` : ''}
                ${lora.baseModel ? `<p><strong>Base Model:</strong> ${lora.baseModel}</p>` : ''}
                <p><strong>Filename:</strong> ${lora.name}</p>
                
                ${lora.triggers && lora.triggers.length > 0 ? `
                    <div style="margin: 15px 0;">
                        <strong>Trigger Words:</strong>
                        <div class="lora-triggers" style="margin-top: 10px;">
                            ${lora.triggers.map(trigger => `
                                <span class="trigger-tag" onclick="event.stopPropagation(); addSingleTriggerToPrompt('${trigger.replace(/'/g, "\\\'")}')" title="Click to add to prompt">
                                    ${trigger}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : '<p style="color: #666;">No trigger words available</p>'}
                
                ${lora.description ? `
                    <div style="margin-top: 15px;">
                        <strong>Description:</strong>
                        <p style="color: #aaa; font-size: 13px; margin-top: 5px;">${lora.description.substring(0, 300)}${lora.description.length > 300 ? '...' : ''}</p>
                    </div>
                ` : ''}
                
                <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                    <button onclick="event.stopPropagation(); addLoraFromModal('${lora.name.replace(/'/g, "\\\'")}')">Add to Generation</button>
                    ${lora.triggers && lora.triggers.length > 0 ? `
                        <button class="btn-secondary" onclick="event.stopPropagation(); copyAllTriggers(${JSON.stringify(lora.triggers).replace(/"/g, '&quot;')})">Copy All Triggers</button>
                        <button class="btn-secondary" onclick="event.stopPropagation(); addTriggersToPrompt(${JSON.stringify(lora.triggers).replace(/"/g, '&quot;')})">Add Triggers to Prompt</button>
                    ` : ''}
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        function addLoraFromModal(loraName) {
            addLoraFromBrowser(loraName);
            closeModal();
        }
        
        function filterLoras() {
            renderLoraBrowser();
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Visual feedback
                const temp = document.createElement('div');
                temp.textContent = 'Copied: ' + text;
                temp.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4a9eff; color: white; padding: 10px 20px; border-radius: 6px; z-index: 10000;';
                document.body.appendChild(temp);
                setTimeout(() => temp.remove(), 2000);
            }).catch(err => console.error('Copy failed:', err));
        }
        
        function copyAllTriggers(triggers) {
            if (triggers.length === 0) return;
            const text = triggers.join(', ');
            copyToClipboard(text);
        }
        
        function addTriggersToPrompt(triggers) {
            if (triggers.length === 0) return;
            
            const promptBox = document.getElementById('prompt');
            const currentPrompt = promptBox.value.trim();
            const triggerText = triggers.join(', ');
            
            // Add triggers to prompt
            if (currentPrompt) {
                promptBox.value = currentPrompt + ', ' + triggerText;
            } else {
                promptBox.value = triggerText;
            }
            
            // Save settings
            saveSettings();
            
            // Visual feedback
            const temp = document.createElement('div');
            temp.textContent = 'Triggers added to prompt';
            temp.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4aff4a; color: black; padding: 10px 20px; border-radius: 6px; z-index: 10000;';
            document.body.appendChild(temp);
            setTimeout(() => temp.remove(), 2000);
        }
        
        function addSingleTriggerToPrompt(trigger) {
            const promptBox = document.getElementById('prompt');
            const currentPrompt = promptBox.value.trim();
            
            // Add single trigger to prompt
            if (currentPrompt) {
                promptBox.value = currentPrompt + ', ' + trigger;
            } else {
                promptBox.value = trigger;
            }
            
            // Save settings
            saveSettings();
            
            // Visual feedback
            const temp = document.createElement('div');
            temp.textContent = 'Added: ' + trigger;
            temp.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4aff4a; color: black; padding: 10px 20px; border-radius: 6px; z-index: 10000;';
            document.body.appendChild(temp);
            setTimeout(() => temp.remove(), 1500);
        }
        
        function addLoraFromBrowser(loraName) {
            // Add to LoRA list if not already added
            const exists = state.loraItems.find(l => l.name === loraName);
            if (!exists) {
                state.loraItems.push({
                    id: Date.now(),
                    name: loraName,
                    weight: 1.0
                });
                renderLoras();
                saveSettings();
            }
            
            // Switch to txt2img tab
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => t.classList.remove('active'));
            tabs[0].classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('txt2img').classList.add('active');
            document.getElementById('shared-settings').style.display = 'block';
            
            // Visual feedback
            const temp = document.createElement('div');
            temp.textContent = 'LoRA added to generation settings';
            temp.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4aff4a; color: black; padding: 10px 20px; border-radius: 6px; z-index: 10000;';
            document.body.appendChild(temp);
            setTimeout(() => temp.remove(), 2000);
        }
        
        // Settings persistence
        function saveSettings() {
            const settings = {
                prompt: document.getElementById('prompt').value,
                negative_prompt: document.getElementById('negative_prompt').value,
                model: document.getElementById('model').value,
                vae: document.getElementById('vae').value,
                quantization: document.getElementById('quantization').value,
                sampler: document.getElementById('sampler').value,
                steps: document.getElementById('steps').value,
                cfg_scale: document.getElementById('cfg_scale').value,
                clip_skip: document.getElementById('clip_skip').value,
                seed: document.getElementById('seed').value,
                batch_size: document.getElementById('batch_size').value,
                width: document.getElementById('width').value,
                height: document.getElementById('height').value,
                upscaler: document.getElementById('upscaler').value,
                upscale_factor: document.getElementById('upscale_factor').value,
                loras: state.loraItems
            };
            localStorage.setItem('sdcpp_settings', JSON.stringify(settings));
        }
        
        function loadSettings() {
            const saved = localStorage.getItem('sdcpp_settings');
            if (!saved) return;
            
            try {
                const settings = JSON.parse(saved);
                
                // Restore all non-select inputs immediately
                Object.entries(settings).forEach(([key, value]) => {
                    if (key === 'loras') return; // Handle separately
                    
                    const el = document.getElementById(key);
                    if (el && el.tagName !== 'SELECT') {
                        el.value = value;
                        if (el.type === 'range') updateSlider(el);
                    }
                });
                
                if (settings.loras) {
                    state.loraItems = settings.loras;
                    renderLoras();
                }
                
                updateAspectPreview();
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }
        
        // Auto-save on input change
        function setupAutoSave() {
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('change', saveSettings);
                input.addEventListener('input', saveSettings);
            });
        }
        
        // Initialize
        window.addEventListener('load', () => {
            // First load resources, then restore settings
            loadResources().then(() => {
                // Settings are now restored in updateSelects() for dropdowns
                loadSettings(); // This restores everything else
            });
            setupAutoSave();
            setupMaskPainting();
            updateAspectPreview();
            
            // Update all sliders
            document.querySelectorAll('input[type="range"]').forEach(updateSlider);
        });
        
        // Close modal on escape
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
